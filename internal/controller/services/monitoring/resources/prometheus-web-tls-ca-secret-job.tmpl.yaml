# TODO: This workaround can be simplified when COO-1270 is complete
# https://issues.redhat.com/browse/COO-1270
# COO-1270 will allow MonitoringStack to leverage service-CA operator directly,
# eliminating the need for this Job that copies CA from ConfigMap to Secret.
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-tls-ca-copy
  namespace: {{.Namespace}}
  labels:
    platform.opendatahub.io/part-of: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: prometheus-tls-ca-copy
  namespace: {{.Namespace}}
  labels:
    platform.opendatahub.io/part-of: monitoring
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "update", "patch"]
  resourceNames: ["prometheus-web-tls-ca"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: prometheus-tls-ca-copy
  namespace: {{.Namespace}}
  labels:
    platform.opendatahub.io/part-of: monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: prometheus-tls-ca-copy
subjects:
- kind: ServiceAccount
  name: prometheus-tls-ca-copy
  namespace: {{.Namespace}}
---
# Job to copy CA from ConfigMap to Secret (MonitoringStack requires Secret)
apiVersion: batch/v1
kind: Job
metadata:
  name: prometheus-web-tls-ca-copy
  namespace: {{.Namespace}}
  labels:
    platform.opendatahub.io/part-of: monitoring
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: prometheus-tls-ca-copy
    spec:
      restartPolicy: OnFailure
      serviceAccountName: prometheus-tls-ca-copy
      containers:
        - name: copy-ca
          image: registry.redhat.io/openshift4/ose-cli:latest
          command:
            - /bin/bash
            - -c
            - |
              set -e

              # Wait for CA ConfigMap to be populated
              echo "Waiting for CA ConfigMap to be populated..."
              while [ ! -f /ca-configmap/service-ca.crt ]; do
                echo "Waiting for service-ca.crt..."
                sleep 2
              done

              echo "Applying CA Secret..."
              kubectl create secret generic prometheus-web-tls-ca \
                -n {{.Namespace}} \
                --from-file=service-ca.crt=/ca-configmap/service-ca.crt \
                --dry-run=client -o yaml | kubectl apply -f -

              echo "CA Secret applied successfully"
          volumeMounts:
            - name: ca-configmap
              mountPath: /ca-configmap
              readOnly: true
      volumes:
        - name: ca-configmap
          configMap:
            name: prometheus-web-tls-ca
