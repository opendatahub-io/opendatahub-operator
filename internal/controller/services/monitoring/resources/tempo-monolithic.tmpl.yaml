apiVersion: tempo.grafana.com/v1alpha1
kind: TempoMonolithic
metadata:
  name: data-science-tempomonolithic
  namespace: {{.Namespace}}
spec:
  resources:
    limits:
      cpu: {{.TempoCPULimit}}
      memory: {{.TempoMemoryLimit}}
    requests:
      cpu: {{.TempoCPURequest}}
      memory: {{.TempoMemoryRequest}}
  multitenancy:
    enabled: true
    mode: openshift
    authentication:
      - tenantId: {{.Namespace}}
        tenantName: {{.Namespace}}
  storage:
    traces:
      backend: pv
      {{- if .Size }}
      size: "{{.Size}}"
      {{- end }}
  {{- if and .TempoTLSEnabled .TempoCertificateSecret }}
  # Ingestion TLS is only enabled when explicit certs are provided.
  # In multitenancy/openshift mode, the gateway already handles external TLS,
  # and enabling auto-provisioned receiver TLS conflicts with the gateway's
  # localhost connections (mTLS cert CA mismatch).
  ingestion:
    otlp:
      grpc:
        tls:
          enabled: true
          certName: {{.TempoCertificateSecret}}
          {{- if .TempoCAConfigMap }}
          caName: {{.TempoCAConfigMap}}
          {{- end }}
      http:
        tls:
          enabled: true
          certName: {{.TempoCertificateSecret}}
          {{- if .TempoCAConfigMap }}
          caName: {{.TempoCAConfigMap}}
          {{- end }}
  {{- end }}
  extraConfig:
    tempo:
      compactor:
        compaction:
          block_retention: {{.TracesRetention}}  # default 90days
      {{- if .TempoCertificateSecret }}
      # Only configure HTTP TLS when explicit cert is provided
      # Otherwise, let Tempo operator handle it via OpenShift serving certs
      server:
        http_tls_config:
          cert_file: /var/run/tls/http/server/tls.crt
          key_file: /var/run/tls/http/server/tls.key
      {{- end }}