name: "ODH Community Release Pipeline"
on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        description: The version to release (e.g., 3.1.0).
        required: true
      previous-version:
        type: string
        description: The previous version to replace (e.g., 3.0.0).
        required: true
      openshift-versions:
        type: string
        description: OpenShift version compatibility (e.g., "v4.19" or "v4.19-v4.20").
        required: false
        default: "v4.19-v4.20"

env:
  VERSION: ${{ github.event.inputs.version }}
  PREVIOUS_VERSION: ${{ github.event.inputs.previous-version }}
  OPENSHIFT_VERSIONS: ${{ github.event.inputs.openshift-versions }}
  COMMUNITY_FORK: opendatahub-io/community-operators-prod
  COMMUNITY_UPSTREAM: redhat-openshift-ecosystem/community-operators-prod

jobs:
  create-community-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
    - name: Checkout opendatahub-operator release branch
      uses: actions/checkout@v5
      with:
        repository: opendatahub-io/opendatahub-operator
        ref: odh-${{ env.VERSION }}
        path: opendatahub-operator
        fetch-depth: 0

    - name: Validate OpenShift versions format
      run: |
        OPENSHIFT_VERSIONS="${{ env.OPENSHIFT_VERSIONS }}"
        if ! echo "$OPENSHIFT_VERSIONS" | grep -qE '^v[0-9]+\.[0-9]+(-v[0-9]+\.[0-9]+)?$'; then
          echo "Error: Invalid OpenShift versions format. Expected format: 'v4.19' or 'v4.19-v4.20'"
          exit 1
        fi
        echo "OpenShift versions format is valid: $OPENSHIFT_VERSIONS"
        
    - name: Validate semver
      run: |
        VERSION="${{ env.VERSION }}"
        PREVIOUS_VERSION="${{ env.PREVIOUS_VERSION }}"
        ./opendatahub-operator/.github/scripts/validate-semver.sh "v${VERSION}"
        ./opendatahub-operator/.github/scripts/validate-semver.sh "v${PREVIOUS_VERSION}"

    - name: Validate bundle CSV
      working-directory: opendatahub-operator
      run: |
        VERSION="${{ env.VERSION }}"
        ./.github/scripts/validate-bundle-csv.sh "$VERSION"

    - name: Checkout community-operators-prod upstream
      uses: actions/checkout@v5
      with:
        repository: ${{ env.COMMUNITY_UPSTREAM }}
        path: community-operators-prod
        fetch-depth: 0

    - name: Copy bundle to community-operators-prod
      run: |
        VERSION="${{ env.VERSION }}"
        BUNDLE_DIR="community-operators-prod/operators/opendatahub-operator/${VERSION}"
        mkdir -p "$BUNDLE_DIR"

        # Copy entire bundle contents (manifests, metadata, tests)
        cp -r opendatahub-operator/odh-bundle/* "$BUNDLE_DIR/"
        echo "Copied bundle contents to $BUNDLE_DIR"
        ls -la "$BUNDLE_DIR"

    - name: Prepare community bundle
      run: |
        VERSION="${{ env.VERSION }}"
        PREVIOUS_VERSION="${{ env.PREVIOUS_VERSION }}"
        OPENSHIFT_VERSIONS="${{ env.OPENSHIFT_VERSIONS }}"
        ./opendatahub-operator/.github/scripts/prepare-community-bundle.sh \
          "./community-operators-prod/operators/opendatahub-operator/${VERSION}" \
          "$PREVIOUS_VERSION" \
          "$OPENSHIFT_VERSIONS"

    - name: Validate community bundle
      run: |
        VERSION="${{ env.VERSION }}"
        PREVIOUS_VERSION="${{ env.PREVIOUS_VERSION }}"
        OPENSHIFT_VERSIONS="${{ env.OPENSHIFT_VERSIONS }}"
        ./opendatahub-operator/.github/scripts/validate-community-bundle.sh \
          "./community-operators-prod/operators/opendatahub-operator/${VERSION}" \
          "$PREVIOUS_VERSION" \
          "$OPENSHIFT_VERSIONS"

    - name: Generate GitHub App Token
      id: generate-token
      uses: actions/create-github-app-token@v2
      with:
        app-id: ${{ secrets.ODH_RELEASE_BOT_APP_ID }}
        private-key: ${{ secrets.ODH_RELEASE_BOT_PRIVATE_KEY }}
        repositories: ${{ env.COMMUNITY_FORK }}

    - name: Create Pull Request
      id: create-pr
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ steps.generate-token.outputs.token }}
        path: community-operators-prod
        push-to-fork: ${{ env.COMMUNITY_FORK }}
        base: main
        branch: odh-operator-${{ env.VERSION }}
        committer: ODH Release Bot <noreply@opendatahub.io>
        author: ODH Release Bot <noreply@opendatahub.io>
        title: "operator opendatahub-operator (${{ env.VERSION }})"
        commit-message: |
          Release opendatahub-operator version ${{ env.VERSION }}
    - name: Summary
      if: steps.create-pr.outputs.pull-request-url != ''
      run: |
        VERSION="${{ env.VERSION }}"
        PREVIOUS_VERSION="${{ env.PREVIOUS_VERSION }}"
        OPENSHIFT_VERSIONS="${{ env.OPENSHIFT_VERSIONS }}"
        PR_URL="${{ steps.create-pr.outputs.pull-request-url }}"
        PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
        echo "## Community Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo " Successfully created community release for opendatahub-operator v${VERSION}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
        echo "- **Previous Version**: ${PREVIOUS_VERSION}" >> $GITHUB_STEP_SUMMARY
        echo "- **OpenShift Versions**: ${OPENSHIFT_VERSIONS}" >> $GITHUB_STEP_SUMMARY
        echo "- **PR**: ${PR_URL}" >> $GITHUB_STEP_SUMMARY
        echo "- **PR Number**: ${PR_NUMBER}" >> $GITHUB_STEP_SUMMARY
