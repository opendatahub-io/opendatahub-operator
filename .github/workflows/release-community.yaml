name: "ODH Community Release Pipeline"
on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        description: |
          The version to release (e.g., 3.5.0 or 3.5.0-ea.1).
          Supports EA (early access) versions with -ea.N suffix.
        required: true
      previous-version:
        type: string
        description: |
          (Optional) The previous version to replace.
        required: false
      openshift-versions:
        type: string
        description: OpenShift version compatibility (e.g., "v4.19" or "v4.19-v4.20").
        required: false
        default: "v4.19-v4.20"

env:
  VERSION: ${{ github.event.inputs.version }}
  PREVIOUS_VERSION: ${{ github.event.inputs.previous-version }}
  OPENSHIFT_VERSIONS: ${{ github.event.inputs.openshift-versions }}
  COMMUNITY_FORK: opendatahub-io/community-operators-prod
  COMMUNITY_UPSTREAM: redhat-openshift-ecosystem/community-operators-prod
  BRANCH_PREFIX: odh-operator-
  COMMITTER_NAME: ODH Release Bot
  COMMITTER_EMAIL: noreply@opendatahub.io

jobs:
  create-community-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
    - name: Checkout opendatahub-operator release branch
      uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      with:
        repository: opendatahub-io/opendatahub-operator
        ref: odh-${{ env.VERSION }}
        path: opendatahub-operator
        fetch-depth: 0

    - name: Setup Go
      uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
      with:
        go-version-file: opendatahub-operator/go.mod
        cache: false

    - name: Generate bundle
      working-directory: opendatahub-operator
      run: |
        VERSION="${{ env.VERSION }}"
        make manifests bundle VERSION="${VERSION}" IMG_TAG="v${VERSION}"

    - name: Validate OpenShift versions format
      run: |
        OPENSHIFT_VERSIONS="${{ env.OPENSHIFT_VERSIONS }}"
        if ! echo "$OPENSHIFT_VERSIONS" | grep -qE '^v[0-9]+\.[0-9]+(-v[0-9]+\.[0-9]+)?$'; then
          echo "Error: Invalid OpenShift versions format. Expected format: 'v4.19' or 'v4.19-v4.20'"
          exit 1
        fi
        echo "OpenShift versions format is valid: $OPENSHIFT_VERSIONS"

    - name: Calculate or validate previous version
      id: prev-version
      working-directory: opendatahub-operator
      env:
        PREV_VERSION_INPUT: ${{ github.event.inputs.previous-version }}
      run: |
        VERSION="${{ env.VERSION }}"
        # Use environment variable to prevent command injection
        MANUAL_PREV="$PREV_VERSION_INPUT"

        if [[ -n "$MANUAL_PREV" ]]; then
          echo "Using manual override for previous version: $MANUAL_PREV"
          PREV_VERSION=$(./.github/scripts/calculate-previous-version.sh "$VERSION" "$MANUAL_PREV")
        else
          echo "Auto-calculating previous version for $VERSION"
          PREV_VERSION=$(./.github/scripts/calculate-previous-version.sh "$VERSION")
        fi

        echo "Previous version resolved to: $PREV_VERSION"
        echo "PREVIOUS_VERSION=$PREV_VERSION" >> $GITHUB_ENV

    - name: Validate semver
      run: |
        VERSION="${{ env.VERSION }}"
        PREVIOUS_VERSION="${{ env.PREVIOUS_VERSION }}"
        ./opendatahub-operator/.github/scripts/validate-semver.sh "v${VERSION}"
        ./opendatahub-operator/.github/scripts/validate-semver.sh "v${PREVIOUS_VERSION}"

    - name: Validate bundle CSV
      working-directory: opendatahub-operator
      run: |
        VERSION="${{ env.VERSION }}"
        ./.github/scripts/validate-bundle-csv.sh "$VERSION"

    - name: Generate GitHub App Token
      id: generate-token
      uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
      with:
        app-id: ${{ secrets.ODH_RELEASE_BOT_APP_ID }}
        private-key: ${{ secrets.ODH_RELEASE_BOT_PRIVATE_KEY }}
        owner: opendatahub-io
        repositories: community-operators-prod

    - name: Checkout community-operators-prod fork
      uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      with:
        repository: ${{ env.COMMUNITY_FORK }}
        path: community-operators-prod
        fetch-depth: 0
        token: ${{ steps.generate-token.outputs.token }}

    - name: Copy bundle to community-operators-prod
      run: |
        VERSION="${{ env.VERSION }}"
        BUNDLE_DIR="community-operators-prod/operators/opendatahub-operator/${VERSION}"
        mkdir -p "$BUNDLE_DIR"

        # Copy entire bundle contents (manifests, metadata, tests)
        cp -r opendatahub-operator/odh-bundle/* "$BUNDLE_DIR/"
        echo "Copied bundle contents to $BUNDLE_DIR"
        ls -la "$BUNDLE_DIR"

    - name: Prepare community bundle
      run: |
        VERSION="${{ env.VERSION }}"
        PREVIOUS_VERSION="${{ env.PREVIOUS_VERSION }}"
        OPENSHIFT_VERSIONS="${{ env.OPENSHIFT_VERSIONS }}"
        ./opendatahub-operator/.github/scripts/prepare-community-bundle.sh \
          "./community-operators-prod/operators/opendatahub-operator/${VERSION}" \
          "$PREVIOUS_VERSION" \
          "$OPENSHIFT_VERSIONS"

    - name: Validate community bundle
      run: |
        VERSION="${{ env.VERSION }}"
        PREVIOUS_VERSION="${{ env.PREVIOUS_VERSION }}"
        OPENSHIFT_VERSIONS="${{ env.OPENSHIFT_VERSIONS }}"
        ./opendatahub-operator/.github/scripts/validate-community-bundle.sh \
          "./community-operators-prod/operators/opendatahub-operator/${VERSION}" \
          "$PREVIOUS_VERSION" \
          "$OPENSHIFT_VERSIONS"

    - name: Create Pull Request
      id: create-pr
      env:
        GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        VERSION: ${{ env.VERSION }}
        COMMUNITY_FORK: ${{ env.COMMUNITY_FORK }}
        COMMUNITY_UPSTREAM: ${{ env.COMMUNITY_UPSTREAM }}
        BUNDLE_DIR: community-operators-prod
        BRANCH_PREFIX: ${{ env.BRANCH_PREFIX }}
        COMMITTER_NAME: ${{ env.COMMITTER_NAME }}
        COMMITTER_EMAIL: ${{ env.COMMITTER_EMAIL }}
      run: |
        ./opendatahub-operator/.github/scripts/create-community-pr.sh
    - name: Summary
      if: steps.create-pr.outputs.pull-request-url != ''
      run: |
        VERSION="${{ env.VERSION }}"
        PREVIOUS_VERSION="${{ env.PREVIOUS_VERSION }}"
        OPENSHIFT_VERSIONS="${{ env.OPENSHIFT_VERSIONS }}"
        PR_URL="${{ steps.create-pr.outputs.pull-request-url }}"
        PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
        echo "## Community Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo " Successfully created community release for opendatahub-operator v${VERSION}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
        echo "- **Previous Version**: ${PREVIOUS_VERSION}" >> $GITHUB_STEP_SUMMARY
        echo "- **OpenShift Versions**: ${OPENSHIFT_VERSIONS}" >> $GITHUB_STEP_SUMMARY
        echo "- **PR**: ${PR_URL}" >> $GITHUB_STEP_SUMMARY
        echo "- **PR Number**: ${PR_NUMBER}" >> $GITHUB_STEP_SUMMARY
