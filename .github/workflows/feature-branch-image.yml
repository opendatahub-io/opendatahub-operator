---
name: Build and Push Feature Branch Custom Catalog
env:
  OPERATOR_IMG: quay.io/${{ secrets.QUAY_ORG }}/opendatahub-operator:${{ github.head_ref }}
  BUNDLE_IMG: quay.io/${{ secrets.QUAY_ORG }}/opendatahub-operator-bundle:${{ github.head_ref }}
  CATALOG_IMG: quay.io/${{ secrets.QUAY_ORG }}/opendatahub-operator-catalog:${{ github.head_ref }}
on:
  pull_request_target:
    branches:
      - 'feature-operator-refactor'
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
jobs:
  build-and-push-feature-branch-custom-catalog:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      packages: write
      contents: read
    steps:
      - name: Login to quay.io
        run: |
          podman login -u ${{ secrets.QUAY_ID }} -p ${{ secrets.QUAY_TOKEN }} quay.io
      - name: Build Feature Branch Image
        run: |
          make image-build -e IMG=${{ env.OPERATOR_IMG }}
      - name: Push Feature Branch Image
        run: |
          make image-push -e IMG=${{ env.OPERATOR_IMG }}
      - name: Build Bundle Manifests
        run: |
          make bundle
      - name: Build Feature Branch Bundle
        run: |
          make bundle-build -e BUNDLE_IMG=${{ env.BUNDLE_IMG }}
      - name: Push Feature Branch Bundle to quay.io
        run: |
          make bundle-push -e BUNDLE_IMG=${{ env.BUNDLE_IMG }}
      - name: Build Feature Branch Catalog
        run: |
          make catalog-build -e CATALOG_IMG=${{ env.CATALOG_IMG }} -e BUNDLE_IMG=${{ env.BUNDLE_IMG }}
      - name: Push Feature Branch Catalog to quay.io
        run: |
          make catalog-push -e CATALOG_IMG=${{ env.CATALOG_IMG }}